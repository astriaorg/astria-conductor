version: '3'

services:
  core0:
    container_name: core0
    image: "ghcr.io/celestiaorg/celestia-app:v0.11.0"
    entrypoint: [
      "/bin/bash"
    ]
    command: [
      "/start-celestia-appd.sh"
    ]
    volumes:
      - ${PWD}/tests/docker/start-celestia-appd.sh:/start-celestia-appd.sh:ro
      - keyring-volume:/root/.celestia-app/keyring-test
    networks:
      localnet:
        ipv4_address: 192.167.10.10

  bridge0:
    container_name: bridge0
    depends_on:
      - core0
    image: "ghcr.io/celestiaorg/celestia-node:0.6.1"
    entrypoint: [
      "/bin/bash"
    ]
    command: [
      "/start-bridge.sh"
    ]
    volumes:
      - ${PWD}/tests/docker/wait-for-it.sh:/wait-for-it.sh:ro
      - ${PWD}/tests/docker/start-bridge.sh:/start-bridge.sh:ro
      - keyring-volume:/bridge/keys/keyring-test/:ro
    expose:
      - "26659/tcp"
    ports:
      - "26659:26659"
    networks:
      localnet:
        ipv4_address: 192.167.10.20

  geth0:
    container_name: geth0
    env_file:
      - ./.env
    depends_on:
      - bridge0
    # FIXME - use a tagged version eventually
#    image: "ghcr.io/astriaorg/go-ethereum:latest"
#    image: "ghcr.io/astriaorg/go-ethereum:local"
    image: "ghcr.io/astriaorg/go-ethereum:custom-mempool"
    volumes:
      - ${PWD}/tests/docker/start-geth.sh:/start-geth.sh:ro
    ports:
      - "50051:50051"
    entrypoint: [
        "/start-geth.sh"
    ]
    command: "--goerli --grpc --grpc.addr \"0.0.0.0\" --grpc.port 50051"
    networks:
      localnet:
        ipv4_address: 192.167.10.30

  metro0:
    container_name: metro0
    depends_on:
      - bridge0
    # FIXME - use a tagged version eventually
    image: "ghcr.io/astriaorg/metro:latest"
    healthcheck:
      # test for existence of priv_validator_key.json, so that dependent services start correctly
      test: test -f /root/.metro/config/priv_validator_key.json || exit 1
      interval: 2s
      timeout: 20s
      retries: 10
    ports:
      - "26657:26657"
      - "1317:1317"
    volumes:
      - shared-volume:/root/.metro/config
    networks:
      localnet:
        ipv4_address: 192.167.10.40

  relayer0:
    container_name: relayer0
    depends_on:
      metro0:
        condition: service_healthy
      bridge0:
        condition: service_started
    # FIXME - use a tagged version eventually
    image: "ghcr.io/astriaorg/sequencer-relayer:latest"
    entrypoint: "/app/target/release/relayer --sequencer-endpoint http://192.167.10.40:1317 --celestia-endpoint http://192.167.10.20:26659"
    volumes:
      - shared-volume:/root/.metro/config:ro
    networks:
      localnet:
        ipv4_address: 192.167.10.50

volumes:
  keyring-volume:
  shared-volume:

networks:
  localnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.167.10.0/24
